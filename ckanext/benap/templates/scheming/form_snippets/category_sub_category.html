{% import 'macros/form.html' as form %}

<style>
    /* Styling for the accordion-style categories and tags */
    .category-header {
        display: flex;
        align-items: center;
        cursor: pointer;
        justify-content: space-between;
    }

    .category-checkbox {
        margin-right: 8px;
    }

    .category-name {
        font-weight: bold;
    }

    .tag-container {
        padding-left: 20px;
        margin-top: 5px; /* Reduced margin between category and tags */
        display: none; /* Initially hidden */
    }

    .tag-container input[type="checkbox"] {
        margin-right: 5px;
        margin-bottom: 2px; /* Reduced margin between tags */
    }
</style>

{% call form.input(
    field.field_name,
    id='field-' + field.field_name,
    label=h.scheming_language_text(field.label),
    placeholder=h.scheming_language_text(field.form_placeholder),
    value=data[field.field_name],
    error=errors[field.field_name],
    classes=field.classes if 'classes' in field else ['control-medium'],
    attrs=dict({"class": "form-control"}, **(field.get('form_attrs', {}))),
    is_required=h.scheming_field_required(field)
    )
%}
    {%- set lang = h.lang() -%}
    {%- set english = 'en' -%}
    {%- set choices = h.benap_get_translated_category_and_sub_category() -%}
    {%- if field.get('sorted_choices') -%}
        {%- set choices = choices|sort(case_sensitive=false, attribute=1) -%}
    {%- endif -%}
    {%- snippet 'scheming/form_snippets/help_text.html', field=field -%}
    <fieldset class="checkboxes">
        {%- for category, tags in choices -%}
            <!-- Category container with accordion and main checkbox -->
            <div class="category-container">
                <div class="flex-between border-1" style="padding: 6px 12px" id="category-{{ loop.index }}">
                    {%- for val, label in category -%}
                        <label class="m-0" style="font-size: 14px; font-weight: bold;">
                            <input type="checkbox" class="category-checkbox" data-category="{{ val }}" {{ "checked " if val in h.benap_retrieve_dict_items_or_keys_or_values(data[field.field_name], "keys") }} />
                            {{ h.benap_scheming_language_text(label, lang) }}
                        </label>
                    {%- endfor -%}
                    <span class="category-caret"></span> <!-- Icon for accordion -->
                </div>

                <!-- Tags for each category, initially hidden -->
                <div class="tag-container" id="tag-container-{{ loop.index }}">

                    {%- for val, label in tags -%}
                        <label>
                            <input type="checkbox"
                                   class="tag-checkbox"
                                   data-category="{{ category[0][0] }}"
                                   value="{{ val }}"
                                   {{ "checked " if val in h.benap_retrieve_dict_items_or_keys_or_values(data[field.field_name], "values") }}
                                   {{ "disabled " if category[0][0] not in h.benap_retrieve_dict_items_or_keys_or_values(data[field.field_name], "keys") }} />
                            {{ h.benap_scheming_language_text(label, lang) }}
                        </label>
                    {%- endfor -%}
                </div>
            </div>
        {%- endfor -%}
    </fieldset>

    <script>
        $('#field-{{ field.field_name }}').toggle();

        $(document).ready(function() {
            // Dictionary to store categories and their corresponding tag values
            let categoryTags = {};

            // Initialize categoryTags from the hidden field if it has a value
            const initialData = $('#field-{{ field.field_name }}').val();
            if (initialData) {
                categoryTags = JSON.parse(initialData);
                // Open tag containers for categories that already have selected tags
                for (const category in categoryTags) {
                    if (categoryTags[category].length > 0) {
                        // Show the tag container for this category
                        const tagContainer = $(`.tag-checkbox[data-category="${category}"]`).closest('.category-container').find('.tag-container');
                        tagContainer.slideDown();
                        // Check the appropriate tag checkboxes
                        categoryTags[category].forEach(tagValue => {
                            const tagCheckbox = tagContainer.find(`.tag-checkbox[value="${tagValue}"]`);
                            if (tagCheckbox.length) {
                                tagCheckbox.prop('checked', true);
                            }
                        });
                    }
                }
            }

            // Function to update the hidden field with the JSON string
            function updateField() {
                if (Object.keys(categoryTags).length === 0) {
                    $('#field-{{ field.field_name }}').val(null);
                } else {
                    $('#field-{{ field.field_name }}').val(JSON.stringify(categoryTags));
                }
            }

            // Function to check if any tags are selected for a given category
            function hasSelectedTags(categoryValue) {
                const tagCheckboxes = $(`.tag-checkbox[data-category="${categoryValue}"]`);
                return tagCheckboxes.is(':checked');
            }

            // Toggle display of tags and enable/disable based on category selection
            $('.category-checkbox').on('change', function() {
                let categoryValue = $(this).data('category'); // Use data-category for the selected category
                let tagContainer = $(this).closest('.category-container').find('.tag-container');
                let tagCheckboxes = tagContainer.find('.tag-checkbox');

                if (this.checked) {
                    tagContainer.slideDown();
                    tagCheckboxes.prop('disabled', false);  // Enable tag checkboxes

                    // Ensure the category is added to categoryTags with an empty array if no tags are selected
                    if (!(categoryValue in categoryTags)) {
                        categoryTags[categoryValue] = [];
                    }

                    // Check if there are already selected tags and open the container if so
                    if (hasSelectedTags(categoryValue)) {
                        tagContainer.slideDown();
                    }
                } else {
                    tagContainer.slideUp();
                    tagCheckboxes.prop('disabled', true);   // Disable tag checkboxes
                    tagCheckboxes.prop('checked', false);   // Uncheck all tags if category is unchecked
                    delete categoryTags[categoryValue];     // Remove category from categoryTags
                }

                // Update the field with the current tags as a JSON string
                updateField();
            });

            // Event listener for the tag-checkboxes
            $('.tag-checkbox').change(function() {
                // Get the category value
                let category = $(this).data('category');

                // Ensure the category is in categoryTags
                if (!(category in categoryTags)) {
                    categoryTags[category] = [];
                }

                if (this.checked) {
                    // Add tag value to the array for the corresponding category
                    if (!categoryTags[category].includes(this.value)) {
                        categoryTags[category].push(this.value);
                    }
                } else {
                    // Remove tag value from the array for the corresponding category
                    categoryTags[category] = categoryTags[category].filter(tag => tag !== this.value);
                    // If there are no tags left for this category, set the value to an empty array
                    if (categoryTags[category].length === 0) {
                        delete categoryTags[category]; // Remove the category if no tags are left
                    }
                }

                // Check if any tags are selected for the category and toggle the tag container
                const tagContainer = $(this).closest('.tag-container');
                if (hasSelectedTags(category)) {
                    tagContainer.slideDown(); // Open if any tag is selected
                } else {
                    tagContainer.slideUp(); // Close if no tags are selected
                }

                // Update the field with the current tags as a JSON string
                updateField();
            });

            // Accordion toggle for category header
            $('.flex-between').click(function(event) {
                if (!$(event.target).is('.category-checkbox')) { // Only toggle when clicking outside checkbox
                    let tagContainer = $(this).siblings('.tag-container');
                    tagContainer.slideToggle();
                    $(this).find('.caret').toggleClass('dropup'); // Toggle caret icon direction
                }
            });
        });
    </script>
    
{%- endcall -%}
